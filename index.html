<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pro House Beat Sequencer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.39/build/Tone.js"></script>
  <style>
    :root {
      --bg: #121212;
      --panel: #181818;
      --border: #2a2a2a;
      --text: #e0e0e0;
      --accent: #00b894;
      --accent-2: #7df9ff;
      --current: #ffffff;
    }
    * { box-sizing: border-box; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      padding: 24px;
      text-align: center;
    }
    h1 { font-size: 1.35rem; font-weight: 600; margin: 0 0 10px; }
    .topbar {
      display: flex; flex-wrap: wrap; align-items: center; justify-content: center;
      gap: 8px; margin-bottom: 10px;
    }
    .badge {
      font-size: .85rem; color: #bdbdbd;
      padding: 6px 10px; background: var(--panel); border: 1px solid var(--border);
      border-radius: 8px; min-width: 120px;
    }
    #gridWrap {
      display: grid; place-items: center;
    }
    #grid {
      display: grid;
      grid-template-columns: repeat(16, 32px);
      gap: 6px;
      padding: 14px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 0 22px rgba(0,0,0,.35);
      margin: 12px auto 16px;
      touch-action: manipulation;
      user-select: none;
    }
    .cell {
      width: 32px; height: 32px; border-radius: 6px;
      background: #1e1e1e; border: 1px solid #2f2f2f;
      cursor: pointer; transition: transform .06s ease, box-shadow .12s ease, background .12s ease;
    }
    .cell.active { background: var(--accent); box-shadow: 0 0 8px var(--accent); }
    .cell.current { outline: 2px solid var(--current); }
    .toolbar {
      display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin: 8px 0 14px;
    }
    button, select {
      background: var(--panel); color: var(--text);
      border: 1px solid var(--border); border-radius: 8px;
      padding: 10px 14px; font-size: .95rem; cursor: pointer;
      transition: background .15s ease, border-color .15s ease;
    }
    button:hover, select:hover { background: #1c1c1c; border-color: #3a3a3a; }
    .controls {
      display: flex; flex-wrap: wrap; gap: 26px; justify-content: center; margin-top: 6px;
    }
    .control { display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .control label { font-size: .85rem; color: #bdbdbd; }
    /* Thicker, easier sliders */
    input[type="range"] {
      -webkit-appearance: none; appearance: none;
      width: 180px; height: 36px; background: transparent;
      padding: 6px 0; /* bigger touch target */
    }
    input[type="range"]::-webkit-slider-runnable-track {
      height: 10px; background: #2a2a2a; border-radius: 999px; border: 1px solid #3a3a3a;
    }
    input[type="range"]::-moz-range-track {
      height: 10px; background: #2a2a2a; border-radius: 999px; border: 1px solid #3a3a3a;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none;
      width: 24px; height: 24px; border-radius: 50%;
      background: var(--accent); border: 2px solid #0f0f0f; margin-top: -7px; /* centers on track */
      box-shadow: 0 0 10px rgba(0,184,148,.4);
    }
    input[type="range"]::-moz-range-thumb {
      width: 24px; height: 24px; border-radius: 50%;
      background: var(--accent); border: 2px solid #0f0f0f;
      box-shadow: 0 0 10px rgba(0,184,148,.4);
    }
    @media (max-width: 800px) {
      #grid { grid-template-columns: repeat(16, 24px); gap: 4px; }
      .cell { width: 24px; height: 24px; border-radius: 5px; }
      input[type="range"] { width: 160px; }
    }
  </style>
</head>
<body>
  <h1>Pro House Beat Sequencer</h1>

  <div class="topbar">
    <div class="badge" id="pageLabel">Page: Drums</div>
    <div class="badge" id="statusLabel">Status: Stopped</div>
  </div>

  <div id="gridWrap">
    <div id="grid"></div>
  </div>

  <div class="toolbar">
    <button id="play">▶ Play / Stop</button>
    <button id="pageToggle">Switch Page</button>

    <select id="preset">
      <option value="deep">Deep House</option>
      <option value="tech">Tech House</option>
      <option value="minimal">Minimal</option>
    </select>

    <select id="randomVibe">
      <option value="fisher">Randomize: Fisher</option>
      <option value="john">Randomize: John Summit</option>
      <option value="dom">Randomize: Dom Dolla</option>
      <option value="kygo">Randomize: Kygo</option>
      <option value="alesso">Randomize: Alesso</option>
      <option value="full">Randomize: Full Random</option>
    </select>
    <button id="applyVibe">Apply</button>
  </div>

  <div class="controls">
    <div class="control">
      <label for="tempo">Tempo (BPM)</label>
      <input type="range" id="tempo" min="80" max="160" value="124">
    </div>
    <div class="control">
      <label for="filter">Low-pass Cutoff</label>
      <input type="range" id="filter" min="200" max="12000" value="5500">
    </div>
    <div class="control">
      <label for="swing">Swing (%)</label>
      <input type="range" id="swing" min="0" max="100" value="12">
    </div>
  </div>

  <script>
    // -------------------------------
    // Data model (not tied to the DOM)
    // -------------------------------
    const pages = [
      { name: "Drums", instruments: ["Kick", "Snare", "HiHat"] },
      { name: "Percussion", instruments: ["Clap", "Shaker", "Bass"] }
    ];
    const STEPS = 16;

    // active[page][row][step] = boolean
    const active = Array.from({ length: pages.length }, (_, p) =>
      Array.from({ length: pages[p].instruments.length }, () =>
        Array.from({ length: STEPS }, () => false)
      )
    );

    let currentPage = 0;
    let stepIndex = 0;
    let playing = false;

    // -------------------------------
    // UI (render from state)
    // -------------------------------
    const grid = document.getElementById("grid");
    const pageLabel = document.getElementById("pageLabel");
    const statusLabel = document.getElementById("statusLabel");

    function buildGrid() {
      // Render visible page only, from state
      grid.innerHTML = "";
      const rows = pages[currentPage].instruments.length;
      for (let r = 0; r < rows; r++) {
        for (let s = 0; s < STEPS; s++) {
          const cell = document.createElement("div");
          cell.className = "cell";
          if (active[currentPage][r][s]) cell.classList.add("active");
          if (s === stepIndex) cell.classList.add("current");

          // Debounce clicks within a frame
          let toggling = false;
          cell.addEventListener("pointerdown", () => {
            if (toggling) return;
            toggling = true;
            active[currentPage][r][s] = !active[currentPage][r][s];
            cell.classList.toggle("active", active[currentPage][r][s]);
            // small timeout to avoid double toggles on mobile
            setTimeout(() => (toggling = false), 30);
          });

          grid.appendChild(cell);
        }
      }
      pageLabel.textContent = `Page: ${pages[currentPage].name}`;
    }

    function updateHighlight() {
      // Only updates highlight on visible grid
      const children = grid.children;
      const rows = pages[currentPage].instruments.length;
      for (let r = 0; r < rows; r++) {
        for (let s = 0; s < STEPS; s++) {
          const idx = r * STEPS + s;
          const cell = children[idx];
          if (!cell) continue;
          if (s === stepIndex) cell.classList.add("current");
          else cell.classList.remove("current");
        }
      }
    }

    // -------------------------------
    // Audio setup
    // -------------------------------
    const instruments = {
      "Kick": new Tone.MembraneSynth(),
      "Snare": new Tone.NoiseSynth({ envelope: { attack: 0.001, decay: 0.2, sustain: 0 } }),
      "HiHat": new Tone.MetalSynth({ envelope: { attack: 0.001, decay: 0.08, release: 0.08 }, resonance: 4000 }),
      "Clap": new Tone.NoiseSynth({ envelope: { attack: 0.001, decay: 0.15 }, volume: -4 }),
      "Shaker": new Tone.MetalSynth({ envelope: { attack: 0.001, decay: 0.05, release: 0.03 }, volume: -8 }),
      "Bass": new Tone.MonoSynth({ oscillator: { type: "sawtooth" }, filter: { Q: 2 }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.25, release: 0.5 } })
    };
    const filter = new Tone.Filter(5500, "lowpass").toDestination();
    Object.values(instruments).forEach(inst => inst.connect(filter));

    // Transport defaults
    Tone.Transport.bpm.value = 124;
    Tone.Transport.swing = 0.12;
    Tone.Transport.swingSubdivision = "16n";

    // Core loop — reads from state only (never from DOM)
    const loop = new Tone.Loop((time) => {
      // trigger notes for ALL pages (engine is page-agnostic)
      pages.forEach((page, pIdx) => {
        page.instruments.forEach((instName, r) => {
          if (active[pIdx][r][stepIndex]) {
            const note = instName === "Bass" ? "C2" : "C2"; // simple trigger for now
            instruments[instName].triggerAttackRelease(note, "8n", time);
          }
        });
      });
      // advance step safely
      stepIndex = (stepIndex + 1) % STEPS;
      updateHighlight();
    }, "16n");

    // Watchdog: resync every bar to ensure no drift
    Tone.Transport.scheduleRepeat(() => {
      stepIndex = stepIndex % STEPS;
      updateHighlight();
    }, "1m");

    // -------------------------------
    // Controls
    // -------------------------------
    document.getElementById("play").addEventListener("click", async () => {
      if (!playing) {
        await Tone.start();
        loop.start(0);
        Tone.Transport.start();
        playing = true;
        statusLabel.textContent = "Status: Playing";
      } else {
        Tone.Transport.stop();
        loop.stop();
        stepIndex = 0;
        updateHighlight();
        playing = false;
        statusLabel.textContent = "Status: Stopped";
      }
    });

    document.getElementById("pageToggle").addEventListener("click", () => {
      currentPage = (currentPage + 1) % pages.length;
      buildGrid(); // just re-render; engine keeps running
    });

    document.getElementById("tempo").addEventListener("input", e => {
      Tone.Transport.bpm.value = +e.target.value;
    });
    document.getElementById("filter").addEventListener("input", e => {
      filter.frequency.value = +e.target.value;
    });
    document.getElementById("swing").addEventListener("input", e => {
      Tone.Transport.swing = (+e.target.value) / 100;
      Tone.Transport.swingSubdivision = "16n";
    });

    // -------------------------------
    // Presets (deterministic starters)
    // -------------------------------
    function clearAll() {
      for (let p = 0; p < pages.length; p++) {
        for (let r = 0; r < pages[p].instruments.length; r++) {
          active[p][r].fill(false);
        }
      }
      buildGrid();
      updateHighlight();
    }

    function applyPreset(name) {
      clearAll();
      switch (name) {
        case "deep":
          // 118 BPM, darker filter, modest swing
          Tone.Transport.bpm.value = 118;
          document.getElementById("tempo").value = 118;
          filter.frequency.value = 4200;
          document.getElementById("filter").value = 4200;
          Tone.Transport.swing = 0.12;
          document.getElementById("swing").value = 12;
          // 4/4 kick, light hats, snare on 2 & 4 (4,12)
          [0,4,8,12].forEach(s => active[0][0][s] = true); // Kick
          [4,12].forEach(s => active[0][1][s] = true);     // Snare
          [2,6,10,14].forEach(s => active[0][2][s] = true); // HiHat
          // Perc
          [12].forEach(s => active[1][0][s] = true);        // Clap
          [1,3,5,7,9,11,13,15].forEach(s => active[1][1][s] = true); // Shaker
          [0,7,8,15].forEach(s => active[1][2][s] = true);   // Bass hits
          break;

        case "tech":
          Tone.Transport.bpm.value = 126;
          document.getElementById("tempo").value = 126;
          filter.frequency.value = 6500;
          document.getElementById("filter").value = 6500;
          Tone.Transport.swing = 0.16;
          document.getElementById("swing").value = 16;
          // Driving kicks + hats on offs
          [0,2,4,6,8,10,12,14].forEach(s => active[0][0][s] = true); // Kick 8ths
          [4,12].forEach(s => active[0][1][s] = true);               // Snare
          [1,3,5,7,9,11,13,15].forEach(s => active[0][2][s] = true); // Hat offbeats
          [12].forEach(s => active[1][0][s] = true);                  // Clap
          [2,6,10,14].forEach(s => active[1][1][s] = true);           // Shaker 16ths accents
          [0,8].forEach(s => active[1][2][s] = true);                 // Bass roots
          break;

        case "minimal":
          Tone.Transport.bpm.value = 122;
          document.getElementById("tempo").value = 122;
          filter.frequency.value = 3400;
          document.getElementById("filter").value = 3400;
          Tone.Transport.swing = 0.10;
          document.getElementById("swing").value = 10;
          [0,8].forEach(s => active[0][0][s] = true);      // sparse kick
          [12].forEach(s => active[0][1][s] = true);       // snare
          [4,12].forEach(s => active[0][2][s] = true);     // hat sparse
          [3,7,11,15].forEach(s => active[1][1][s] = true);// shaker
          [0,7,14].forEach(s => active[1][2][s] = true);   // minimal bass
          break;
      }
      buildGrid();
      updateHighlight();
    }

    document.getElementById("preset").addEventListener("change", e => applyPreset(e.target.value));

    // -------------------------------
    // Randomize "DJ Vibes"
    // -------------------------------
    function coin(prob) { return Math.random() < prob; }

    function randomizeVibe(name) {
      clearAll();

      let bpm = 124, cutoff = 5500, swing = 0.12;
      // density per instrument (probability a step turns on when considered)
      let dens = {
        Kick: 0.5, Snare: 0.2, HiHat: 0.5,
        Clap: 0.2, Shaker: 0.4, Bass: 0.25
      };

      const setGlobals = () => {
        Tone.Transport.bpm.value = bpm;
        document.getElementById("tempo").value = bpm;
        filter.frequency.value = cutoff;
        document.getElementById("filter").value = cutoff;
        Tone.Transport.swing = swing;
        document.getElementById("swing").value = Math.round(swing * 100);
      };

      switch (name) {
        case "fisher": // punchy tech-house, tight hats, big claps
          bpm = 125; cutoff = 7000; swing = 0.14;
          setGlobals();
          // solid 4/4 kick
          [0,4,8,12].forEach(s => active[0][0][s] = true);
          // snare/clap on 2 & 4
          [4,12].forEach(s => { active[0][1][s] = true; active[1][0][s] = true; });
          // hats off-beat + some 16ths sprinkles
          [1,3,5,7,9,11,13,15].forEach(s => active[0][2][s] = true);
          [2,6,10,14].forEach(s => { if (coin(.3)) active[0][2][s] = true; });
          // shaker grooves
          [2,6,10,14].forEach(s => { if (coin(.6)) active[1][1][s] = true; });
          // bass roots with a couple syncopations
          [0,8].forEach(s => active[1][2][s] = true);
          [6,14].forEach(s => { if (coin(.5)) active[1][2][s] = true; });
          break;

        case "john": // energetic tech; busier hats and percussion
          bpm = 126; cutoff = 7500; swing = 0.16;
          setGlobals();
          [0,2,4,6,8,10,12,14].forEach(s => active[0][0][s] = true); // 8th kicks
          [4,12].forEach(s => { active[0][1][s] = true; active[1][0][s] = true; });
          // driving hats
          for (let s=0; s<STEPS; s++) if (s%2===1 || coin(.2)) active[0][2][s] = true;
          // shaker accents
          [2,6,10,14].forEach(s => { if (coin(.7)) active[1][1][s] = true; });
          // bass pumps
          [0,8].forEach(s => active[1][2][s] = true);
          [4,12].forEach(s => { if (coin(.4)) active[1][2][s] = true; });
          break;

        case "dom": // chunky, swung, groove-forward
          bpm = 124; cutoff = 6200; swing = 0.22;
          setGlobals();
          [0,4,8,12].forEach(s => active[0][0][s] = true);
          [4,12].forEach(s => active[0][1][s] = true);
          // hats: off-beat + shuffled extras
          [1,3,5,7,9,11,13,15].forEach(s => active[0][2][s] = true);
          [6,14].forEach(s => { if (coin(.5)) active[0][2][s] = true; });
          // shaker: ghost 16ths
          for (let s=0; s<STEPS; s++) if (s%4===2 && coin(.7)) active[1][1][s] = true;
          // bass syncopation
          [0,7,8,15].forEach(s => active[1][2][s] = true);
          break;

        case "kygo": // tropical-ish: lighter drums, airy hats, slower
          bpm = 105; cutoff = 9000; swing = 0.10;
          setGlobals();
          [0,8].forEach(s => active[0][0][s] = true); // laid-back kick
          [4,12].forEach(s => active[0][1][s] = true);
          // open airy hats on offbeats
          [2,6,10,14].forEach(s => active[0][2][s] = true);
          // shaker gentle 8ths
          [1,3,5,7,9,11,13,15].forEach(s => { if (coin(.6)) active[1][1][s] = true; });
          // bass: simple & sparse
          [0,8].forEach(s => active[1][2][s] = true);
          if (coin(.4)) active[1][2][12] = true;
          break;

        case "alesso": // progressive: crisp, driving, clean
          bpm = 126; cutoff = 8000; swing = 0.12;
          setGlobals();
          [0,4,8,12].forEach(s => active[0][0][s] = true);
          [4,12].forEach(s => { active[0][1][s] = true; active[1][0][s] = true; });
          // tight hats: every other 16th
          for (let s=0; s<STEPS; s++) if (s%2===0) active[0][2][s] = true;
          // shaker light fills
          [6,14].forEach(s => { if (coin(.5)) active[1][1][s] = true; });
          // bass anchor notes
          [0,8].forEach(s => active[1][2][s] = true);
          break;

        case "full": // chaos but musical constraints
          bpm = 120 + Math.round(Math.random()*20 - 10);
          cutoff = 3500 + Math.round(Math.random()*7000);
          swing = 0.08 + Math.random()*0.2;
          setGlobals();
          // Set densities randomly
          dens = {
            Kick: 0.45 + Math.random()*0.3,
            Snare: 0.12 + Math.random()*0.25,
            HiHat: 0.35 + Math.random()*0.4,
            Clap: 0.08 + Math.random()*0.25,
            Shaker: 0.2 + Math.random()*0.5,
            Bass: 0.15 + Math.random()*0.35
          };
          // ensure 4/4 anchor on kicks
          [0,4,8,12].forEach(s => active[0][0][s] = true);
          // fill by probability
          pages.forEach((page, p) => {
            page.instruments.forEach((inst, r) => {
              for (let s=0; s<STEPS; s++) {
                if (inst==="Kick" && (s%4===0)) continue; // already set
                const prob = dens[inst] || 0.25;
                if (coin(prob)) active[p][r][s] = true;
              }
            });
          });
          break;
      }

      buildGrid();
      updateHighlight();
    }

    document.getElementById("applyVibe").addEventListener("click", () => {
      const vibe = document.getElementById("randomVibe").value;
      randomizeVibe(vibe);
    });

    // -------------------------------
    // Boot: load a solid default so it's never silent
    // -------------------------------
    applyPreset("tech"); // feel free to change to "deep" if you prefer
  </script>
</body>
</html>
