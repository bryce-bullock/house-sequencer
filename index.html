<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>House Beat Sequencer</title>
  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.39/build/Tone.js"></script>
  <style>
    body {
      background: #121212;
      font-family: Arial, sans-serif;
      color: #ddd;
      text-align: center;
      margin: 0;
      padding: 30px;
    }
    h1 { font-size: 1.5em; color: #fff; margin-bottom: 20px; }
    #pageLabel { font-size: 0.9em; margin-bottom: 10px; color: #aaa; }
    #grid {
      display: grid;
      grid-template-columns: repeat(16, 32px);
      gap: 6px;
      margin: 20px auto;
      justify-content: center;
    }
    .cell {
      width: 32px; height: 32px;
      border-radius: 4px;
      background: #1e1e1e;
      border: 1px solid #333;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .cell.active { background: #00b894; box-shadow: 0 0 6px #00b894; }
    .cell.current { border: 1px solid #fff; }
    button, select {
      margin: 8px; padding: 8px 16px;
      font-size: 0.9em; border: none;
      border-radius: 4px;
      background: #333; color: #eee;
      cursor: pointer; transition: background 0.2s ease;
    }
    button:hover, select:hover { background: #444; }
    .controls {
      margin-top: 25px; display: flex; justify-content: center;
      gap: 40px; flex-wrap: wrap;
    }
    .control {
      display: flex; flex-direction: column;
      align-items: center; font-size: 0.8em;
    }
    input[type=range] { width: 140px; accent-color: #00b894; }
  </style>
</head>
<body>
  <h1>House Beat Sequencer</h1>
  <div id="pageLabel">Page: Drums</div>
  <div id="grid"></div>
  <div>
    <button id="play">â–¶ Play / Stop</button>
    <button id="pageToggle">Switch Page</button>
    <select id="preset">
      <option value="deep">Deep House</option>
      <option value="tech">Tech House</option>
      <option value="minimal">Minimal</option>
    </select>
  </div>

  <div class="controls">
    <div class="control">
      <label for="tempo">Tempo</label>
      <input type="range" id="tempo" min="80" max="160" value="120">
    </div>
    <div class="control">
      <label for="filter">Filter</label>
      <input type="range" id="filter" min="200" max="8000" value="5000">
    </div>
    <div class="control">
      <label for="swing">Swing</label>
      <input type="range" id="swing" min="0" max="100" value="0">
    </div>
  </div>

  <div style="margin-top:25px;">
    <input type="text" id="patternName" placeholder="Pattern name" style="padding:6px;">
    <button id="savePattern">ðŸ’¾ Save Pattern</button>
    <select id="savedPatterns"></select>
    <button id="loadPattern">ðŸ“‚ Load</button>
  </div>

  <script>
    const pages = [
      { name: "Drums", instruments: ["Kick", "Snare", "HiHat"] },
      { name: "Percussion", instruments: ["Clap", "Shaker", "Bass"] }
    ];
    let currentPage = 0;
    const grid = document.getElementById("grid");
    const pageLabel = document.getElementById("pageLabel");
    let cells = [];

    function buildGrid() {
      grid.innerHTML = "";
      cells = [];
      pages[currentPage].instruments.forEach((row, r) => {
        for (let i = 0; i < 16; i++) {
          const cell = document.createElement("div");
          cell.classList.add("cell");
          cell.dataset.row = r;
          cell.dataset.step = i;
          cell.dataset.page = currentPage;
          cell.onclick = () => cell.classList.toggle("active");
          grid.appendChild(cell);
          cells.push(cell);
        }
      });
      pageLabel.textContent = `Page: ${pages[currentPage].name}`;
    }
    buildGrid();

    // Instruments
    const instruments = {
      "Kick": new Tone.MembraneSynth().toDestination(),
      "Snare": new Tone.NoiseSynth({ envelope: { attack: 0.001, decay: 0.2, sustain: 0 } }).toDestination(),
      "HiHat": new Tone.MetalSynth({ envelope: { attack: 0.001, decay: 0.1, release: 0.1 } }).toDestination(),
      "Clap": new Tone.NoiseSynth({ envelope: { attack: 0.001, decay: 0.15 }, volume: -6 }).toDestination(),
      "Shaker": new Tone.MetalSynth({ envelope: { attack: 0.001, decay: 0.05 }, volume: -10 }).toDestination(),
      "Bass": new Tone.MonoSynth({ oscillator: { type: "sawtooth" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.6 } }).toDestination()
    };

    const filter = new Tone.Filter(5000, "lowpass").toDestination();
    Object.values(instruments).forEach(inst => inst.connect(filter));

    let stepIndex = 0;
    const loop = new Tone.Loop((time) => {
      cells.forEach(c => c.classList.remove("current"));
      pages[currentPage].instruments.forEach((instName, r) => {
        const cell = cells.find(c => c.dataset.page == currentPage && c.dataset.row == r && c.dataset.step == stepIndex);
        if (cell && cell.classList.contains("active")) {
          instruments[instName].triggerAttackRelease("C2", "8n", time);
        }
        if (cell) cell.classList.add("current");
      });
      stepIndex = (stepIndex + 1) % 16;
    }, "16n");

    let playing = false;
    document.getElementById("play").onclick = async () => {
      if (!playing) {
        await Tone.start();
        Tone.Transport.start();
        loop.start(0);
        playing = true;
      } else {
        Tone.Transport.stop();
        loop.stop();
        stepIndex = 0;
        cells.forEach(c => c.classList.remove("current"));
        playing = false;
      }
    };

    document.getElementById("pageToggle").onclick = () => {
      currentPage = (currentPage + 1) % pages.length;
      buildGrid();
    };

    document.getElementById("tempo").addEventListener("input", e => Tone.Transport.bpm.value = +e.target.value);
    document.getElementById("filter").addEventListener("input", e => filter.frequency.value = +e.target.value);
    document.getElementById("swing").addEventListener("input", e => {
      Tone.Transport.swing = +e.target.value / 100;
      Tone.Transport.swingSubdivision = "16n";
    });

    // Presets (same as before, omitted for brevity)...

    // ---- SAVE / LOAD ----
    function getPatternData() {
      return {
        tempo: +document.getElementById("tempo").value,
        filter: +document.getElementById("filter").value,
        swing: +document.getElementById("swing").value,
        steps: cells.map(c => ({ page: +c.dataset.page, row: +c.dataset.row, step: +c.dataset.step, active: c.classList.contains("active") }))
      };
    }

    function applyPatternData(data) {
      document.getElementById("tempo").value = data.tempo;
      Tone.Transport.bpm.value = data.tempo;
      document.getElementById("filter").value = data.filter;
      filter.frequency.value = data.filter;
      document.getElementById("swing").value = data.swing;
      Tone.Transport.swing = data.swing / 100;
      cells.forEach(c => c.classList.remove("active"));
      data.steps.forEach(s => {
        const cell = cells.find(c => c.dataset.page == s.page && c.dataset.row == s.row && c.dataset.step == s.step);
        if (cell && s.active) cell.classList.add("active");
      });
    }

    function refreshSavedPatterns() {
      const saved = JSON.parse(localStorage.getItem("patterns") || "{}");
      const select = document.getElementById("savedPatterns");
      select.innerHTML = "";
      Object.keys(saved).forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
      });
    }

    document.getElementById("savePattern").onclick = () => {
      const name = document.getElementById("patternName").value.trim();
      if (!name) return alert("Enter a pattern name!");
      const saved = JSON.parse(localStorage.getItem("patterns") || "{}");
      saved[name] = getPatternData();
      localStorage.setItem("patterns", JSON.stringify(saved));
      refreshSavedPatterns();
      document.getElementById("patternName").value = "";
    };

    document.getElementById("loadPattern").onclick = () => {
      const select = document.getElementById("savedPatterns");
      if (!select.value) return alert("No pattern selected");
      const saved = JSON.parse(localStorage.getItem("patterns") || "{}");
      applyPatternData(saved[select.value]);
    };

    refreshSavedPatterns();
  </script>
</body>
</html>
