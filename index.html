<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ultimate Browser DJ Rig</title>
<style>
body {margin:0;background:#111;font-family:'Arial',sans-serif;color:#eee;display:flex;flex-direction:column;height:100vh;overflow:hidden;}
header {background:#0a0a0a;padding:10px;text-align:center;font-size:1.2em;color:#0ff;border-bottom:1px solid #222;}
#visualizer {width:100%;height:150px;background:#000;}
#sequencer {display:flex;flex:1;overflow-x:auto;padding:10px;gap:10px;}
.track {display:flex;flex-direction:column;background:#1a1a1a;border-radius:6px;padding:5px;min-width:350px;}
.track-name{text-align:center;margin-bottom:5px;color:#0ff;font-weight:bold;}
.steps{display:grid;grid-template-columns:repeat(32,20px);gap:2px;margin-bottom:5px;}
.step{width:20px;height:20px;background:#222;border-radius:3px;cursor:pointer;transition:.1s;box-shadow:0 0 2px #000;}
.step.active{background:#0ff;box-shadow:0 0 6px #0ff;}
.fx-panel,.synth-panel{display:flex;flex-direction:column;gap:4px;margin-top:5px;}
.fx-panel label,.synth-panel label{font-size:.7em;color:#0ff;display:flex;justify-content:space-between;}
.fx-panel input,.synth-panel input{width:60%;margin-left:5px;}
#master{display:flex;background:#111;padding:10px;border-top:1px solid #222;gap:10px;align-items:center;flex-wrap:wrap;}
#presets,#samples,#keyboard-controls,#voice-controls{display:flex;gap:5px;flex-wrap:wrap;}
#presets button,#samples button,#master button,#keyboard-controls button,#voice-controls button{background:#222;color:#0ff;border:1px solid #0ff;padding:5px 10px;border-radius:4px;cursor:pointer;}
#presets button:hover,#samples button:hover,#master button:hover,#keyboard-controls button:hover,#voice-controls button:hover{background:#0ff;color:#111;}
#keyboard{display:flex;gap:1px;margin:10px 0;}
.key{width:30px;height:100px;background:#333;border:1px solid #555;border-radius:3px;cursor:pointer;transition:.1s;position:relative;}
.key.white{background:#444;}
.key.black{background:#111;height:60px;width:20px;margin-left:-10px;margin-right:-10px;z-index:2;}
.key.active{box-shadow:0 0 10px #0ff;transform:scale(0.95);}
</style>
</head>
<body>
<header>Ultimate Browser DJ Rig</header>
<canvas id="visualizer"></canvas>
<div id="sequencer"></div>
<div id="keyboard"></div>
<div id="master">
  <div>BPM: <input type="number" id="bpm" value="124" style="width:60px;"></div>
  <div>Pitch (semitones): <input type="number" id="pitch" value="0" style="width:50px;"></div>
  <div>Volume: <input type="range" id="masterVol" min="0" max="1" step="0.01" value="0.8"></div>
  <div id="presets">
    <button data-preset="johnsummit">John Summit</button>
    <button data-preset="fisher">Fisher</button>
    <button data-preset="benbohmer">Ben BÃ¶hmer</button>
    <button data-preset="zhu">Zhu</button>
    <button data-preset="barrycantswim">Barry Can't Swim</button>
    <button data-preset="domdolla">Dom Dolla</button>
    <button data-preset="chrislake">Chris Lake</button>
  </div>
  <div id="samples"></div>
  <div id="master-buttons">
    <button id="play">Play</button>
    <button id="stop">Stop</button>
    <button id="record">Record</button>
    <button id="stopRecord">Stop & Download</button>
    <button id="randomize">Randomize Groove</button>
  </div>
  <div id="voice-controls">
    <button id="micArm">Arm Mic</button>
    Pitch Shift: <input type="range" id="micPitch" min="-12" max="12" step="1" value="0">
    Volume: <input type="range" id="micVol" min="0" max="1" step="0.01" value="0.7">
  </div>
</div>
<script>
// ====== Audio Setup ======
const AudioContext = window.AudioContext || window.webkitAudioContext;
const ctx = new AudioContext();
let bpm = 124, pitchSemitones = 0, isPlaying = false, currentStep = 0, intervalId;
let masterGain = ctx.createGain(); masterGain.connect(ctx.destination);
const analyser = ctx.createAnalyser(); masterGain.connect(analyser); analyser.fftSize = 256;
document.getElementById('masterVol').addEventListener('input', e=>masterGain.gain.value=parseFloat(e.target.value));

// ====== Sequencer Tracks ======
const tracks = [
  {name:"Kick", type:"drum", steps:[]},
  {name:"Clap", type:"drum", steps:[]},
  {name:"Hat", type:"drum", steps:[]},
  {name:"Bass", type:"synth", steps:[]},
  {name:"Pad", type:"synth", steps:[]}
];
tracks.forEach(track=>{for(let i=0;i<32;i++) track.steps.push({active:false,velocity:1,probability:1});});

// ====== Sequencer UI ======
const sequencerEl = document.getElementById('sequencer');
tracks.forEach((track,index)=>{
  const trackEl=document.createElement('div'); trackEl.className='track';
  const nameEl=document.createElement('div'); nameEl.className='track-name'; nameEl.textContent=track.name; trackEl.appendChild(nameEl);
  const stepsEl=document.createElement('div'); stepsEl.className='steps';
  track.steps.forEach((step,i)=>{
    const stepEl=document.createElement('div'); stepEl.className='step';
    stepEl.addEventListener('click',()=>{step.active=!step.active; stepEl.classList.toggle('active',step.active)});
    stepsEl.appendChild(stepEl);
  });
  trackEl.appendChild(stepsEl);
  sequencerEl.appendChild(trackEl);
});

// ====== Audio Functions ======
function playDrum(freq=100,type="sine",duration=0.1,gainVal=0.8){
  const osc=ctx.createOscillator(), gain=ctx.createGain();
  osc.type=type; osc.frequency.setValueAtTime(freq,ctx.currentTime);
  gain.gain.setValueAtTime(gainVal,ctx.currentTime); osc.connect(gain); gain.connect(masterGain);
  osc.start(); osc.stop(ctx.currentTime+duration);
}
function playSynth(note=220,duration=0.3,gainVal=0.6){
  const osc=ctx.createOscillator(), gain=ctx.createGain();
  osc.type='sawtooth'; osc.frequency.setValueAtTime(note*Math.pow(2,pitchSemitones/12),ctx.currentTime);
  gain.gain.setValueAtTime(gainVal,ctx.currentTime); osc.connect(gain); gain.connect(masterGain);
  osc.start(); osc.stop(ctx.currentTime+duration);
}
function randomAtmosSynth(){if(Math.random()<0.1){const freq=100+Math.random()*200;const dur=0.5+Math.random()*0.5;const osc=ctx.createOscillator();const gain=ctx.createGain();osc.type='triangle';osc.frequency.setValueAtTime(freq,ctx.currentTime);gain.gain.setValueAtTime(0.15,ctx.currentTime);osc.connect(gain);gain.connect(masterGain);osc.start();osc.stop(ctx.currentTime+dur);}}
function nextStep(){tracks.forEach(track=>{const step=track.steps[currentStep];if(step.active&&Math.random()<=step.probability){if(track.type==="drum"){let freq=100;if(track.name==="Kick") freq=60;if(track.name==="Clap") freq=300;if(track.name==="Hat") freq=800;playDrum(freq,"sine",0.1,step.velocity);} else {let baseNote=220;if(track.name==="Bass") baseNote=110;if(track.name==="Pad") baseNote=220;playSynth(baseNote,0.3,step.velocity);}randomAtmosSynth();}});currentStep=(currentStep+1)%32;}
function startSequencer(){if(!isPlaying){isPlaying=true;const interval=(60/bpm)/4*1000;intervalId=setInterval(nextStep,interval);}}
function stopSequencer(){isPlaying=false;clearInterval(intervalId);currentStep=0;}

// ====== Presets & Randomizer ======
const presets={johnsummit:()=>{tracks.forEach(t=>t.steps.forEach(s=>s.active=false)); [0,4,8,12].forEach(i=>tracks[0].steps[i].active=true);},fisher:()=>{tracks.forEach(t=>t.steps.forEach(s=>s.active=false)); [0,8,16,24].forEach(i=>tracks[0].steps[i].active=true);}};
document.querySelectorAll('#presets button').forEach(btn=>{btn.addEventListener('click',()=>{const fn=presets[btn.dataset.preset]; if(fn) fn(); document.querySelectorAll('.track').forEach((trackEl,ti)=>{trackEl.querySelectorAll('.step').forEach((stepEl,si)=>{stepEl.classList.toggle('active',tracks[ti].steps[si].active);});});});});
document.getElementById('randomize').addEventListener('click',()=>{tracks.forEach(track=>{track.steps.forEach(step=>{step.active=Math.random()<0.3;step.velocity=0.5+Math.random()*0.5;step.probability=0.5+Math.random()*0.5;});});document.querySelectorAll('.track').forEach((trackEl,ti)=>{trackEl.querySelectorAll('.step').forEach((stepEl,si)=>{stepEl.classList.toggle('active',tracks[ti].steps[si].active);});});});

// ====== Keyboard ======
const keyboardEl=document.getElementById('keyboard'); const keys=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B","C2"];
keys.forEach(note=>{const keyEl=document.createElement('div');keyEl.className='key '+(note.includes("#")?'black':'white');keyEl.dataset.note=note;keyboardEl.appendChild(keyEl);keyEl.addEventListener('mousedown',()=>playSynth(noteToFreq(note)));});
function noteToFreq(note){const map={"C":0,"C#":1,"D":2,"D#":3,"E":4,"F":5,"F#":6,"G":7,"G#":8,"A":9,"A#":10,"B":11,"C2":12};return 261.63*Math.pow(2,map[note]/12);}

// ====== Mic Input ======
let micStream,micSource,micGain;
document.getElementById('micArm').addEventListener('click',async()=>{if(!micStream){micStream=await navigator.mediaDevices.getUserMedia({audio:true});micSource=ctx.createMediaStreamSource(micStream);micGain=ctx.createGain();micSource.connect(micGain).connect(masterGain);}});document.getElementById('micVol').addEventListener('input',e=>{if(micGain) micGain.gain.value=parseFloat(e.target.value);});

// ====== Master Controls ======
document.getElementById('bpm').addEventListener('input', e=>{bpm=parseFloat(e.target.value);});
document.getElementById('pitch').addEventListener('input', e=>{pitchSemitones=parseFloat(e.target.value);});
document.getElementById('play').addEventListener('click', startSequencer);
document.getElementById('stop').addEventListener('click', stopSequencer);

// ====== Recording ======
let mediaRecorder, recordedChunks=[];
document.getElementById('record').addEventListener('click',async()=>{if(ctx.state==="suspended") await ctx.resume();const dest=ctx.createMediaStreamDestination();masterGain.connect(dest);mediaRecorder=new MediaRecorder(dest.stream);recordedChunks=[];mediaRecorder.ondataavailable=e=>{if(e.data.size>0) recordedChunks.push(e.data)};mediaRecorder.start();});
document.getElementById('stopRecord').addEventListener('click',()=>{mediaRecorder.stop();mediaRecorder.onstop=()=>{const blob=new Blob(recordedChunks,{type:'audio/webm'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='performance.webm';a.click();}});

// ====== Visualizer ======
const canvas=document.getElementById('visualizer');const ctxVis=canvas.getContext('2d');canvas.width=window.innerWidth;canvas.height=150;
function drawVisualizer(){requestAnimationFrame(drawVisualizer);const bufferLength=analyser.frequencyBinCount;const dataArray=new Uint8Array(bufferLength);analyser.getByteFrequencyData(dataArray);ctxVis.fillStyle="#000";ctxVis.fillRect(0,0,canvas.width,canvas.height);const barWidth=(canvas.width/bufferLength)*1.5;let x=0;for(let i=0;i<bufferLength;i++){const barHeight=dataArray[i];ctxVis.fillStyle=`hsl(${i*2},100%,50%)`;ctxVis.fillRect(x,canvas.height-barHeight,barWidth,barHeight);x+=barWidth+1;}} drawVisualizer();
</script>
</body>
</html>
