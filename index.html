<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Haus Deck Pro v1.1</title>
<style>
  /* =======================
     GENERAL STYLES
  ======================= */
  html, body {margin:0; padding:0; background:#121212; font-family: 'Arial', sans-serif; color:#eee;}
  * {box-sizing:border-box;}
  h1 {text-align:center; margin:10px 0; color:#f0a500;}
  
  /* =======================
     HEADER
  ======================= */
  #header {padding:10px; text-align:center; background:#1c1c1c; border-bottom:1px solid #333;}
  
  /* =======================
     SEQUENCER GRID
  ======================= */
  .grid {display:grid; gap:2px; margin:10px auto; max-width:960px;}
  .track-row {display:grid; grid-template-columns: repeat(16, 1fr); margin:4px 0;}
  .step {width:100%; padding-top:100%; position:relative; cursor:pointer; border-radius:3px; background:#222; transition:0.1s;}
  .step.active {background:#f0a500;}
  .step:after {content:""; display:block; padding-bottom:100%;}
  
  /* =======================
     MIXER
  ======================= */
  .mixer {display:flex; justify-content:center; margin:10px auto; gap:10px; max-width:960px;}
  .channel {background:#1c1c1c; padding:10px; border-radius:5px; width:120px; display:flex; flex-direction:column; align-items:center;}
  .fader {writing-mode: bt-lr; -webkit-appearance: slider-vertical; width:8px; height:80px; margin:5px 0;}
  .pan {width:80%; margin:5px 0;}
  
  /* =======================
     CONTROLS
  ======================= */
  .controls {display:flex; justify-content:center; gap:10px; margin:10px;}
  button {padding:8px 16px; border:none; border-radius:5px; background:#f0a500; color:#121212; cursor:pointer; transition:0.2s;}
  button:hover {background:#ffbf47;}
  
  select {padding:5px; border-radius:3px; border:none; background:#222; color:#eee;}
  
  /* =======================
     VISUALIZER
  ======================= */
  canvas {display:block; margin:20px auto; background:#000; border:1px solid #333;}
</style>
</head>
<body>
<div id="header"><h1>Haus Deck Pro v1.1</h1></div>

<!-- =======================
     GENRE & PRESET CONTROLS
======================= -->
<div class="controls">
  <select id="genreSelect">
    <option value="deep">Deep House</option>
    <option value="tech">Tech House</option>
    <option value="chill">Chill House</option>
    <option value="lofi">Lo-Fi House</option>
    <option value="progressive">Progressive Starter</option>
  </select>
  <button id="playStop">Play / Stop</button>
  <button id="randomize">Randomize Pattern</button>
  <button id="recordBtn">Record WAV</button>
</div>

<!-- =======================
     SEQUENCER GRID
======================= -->
<div id="sequencer" class="grid"></div>

<!-- =======================
     MIXER
======================= -->
<div class="mixer" id="mixer"></div>

<!-- =======================
     VISUALIZER
======================= -->
<canvas id="visualizer" width="960" height="150"></canvas>

<script>
/* =======================
   HAUS DECK PRO v1.1
   WebAudio + Sequencer Engine
======================= */
const AudioContextClass = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioContextClass();

let isPlaying = false;
let currentStep = 0;
const tempo = 122; // Slightly groovy default
const stepInterval = (60 / tempo) / 4; // 16th notes
const swing = 0.08; // Default swing factor

/* =======================
   TRACK DEFINITIONS
======================= */
const tracks = [
  {name:'Kick', type:'sample', buffer:null, gain:1, steps:Array(16).fill(false), sidechain:true},
  {name:'Snare', type:'sample', buffer:null, gain:0.8, steps:Array(16).fill(false), sidechain:false},
  {name:'HiHat', type:'sample', buffer:null, gain:0.6, steps:Array(16).fill(false), sidechain:false},
  {name:'Bass', type:'synth', synth:'saw', gain:0.8, steps:Array(16).fill(false), sidechain:true},
  {name:'Pad', type:'synth', synth:'pad', gain:0.5, steps:Array(16).fill(false), sidechain:true},
  {name:'FX', type:'synth', synth:'noise', gain:0.5, steps:Array(16).fill(false), sidechain:false}
];

/* =======================
   LOAD DRUM SAMPLES
======================= */
const sampleFiles = {
  Kick:'https://cdn.jsdelivr.net/gh/ai-music-samples/kick.wav',
  Snare:'https://cdn.jsdelivr.net/gh/ai-music-samples/snare.wav',
  HiHat:'https://cdn.jsdelivr.net/gh/ai-music-samples/hihat.wav'
};

async function loadSamples(){
  for(const track of tracks){
    if(track.type==='sample'){
      const resp = await fetch(sampleFiles[track.name]);
      const arrayBuffer = await resp.arrayBuffer();
      track.buffer = await audioCtx.decodeAudioData(arrayBuffer);
    }
  }
}
loadSamples();

/* =======================
   SEQUENCER UI
======================= */
const sequencerDiv = document.getElementById('sequencer');
tracks.forEach((track, i)=>{
  const row = document.createElement('div');
  row.className = 'track-row';
  track.steps.forEach((step,j)=>{
    const s = document.createElement('div');
    s.className = 'step';
    s.addEventListener('click',()=> {
      track.steps[j] = !track.steps[j];
      s.classList.toggle('active');
    });
    row.appendChild(s);
  });
  sequencerDiv.appendChild(row);
});

/* =======================
   MIXER UI
======================= */
const mixerDiv = document.getElementById('mixer');
tracks.forEach((track,i)=>{
  const ch = document.createElement('div'); ch.className='channel';
  const label = document.createElement('div'); label.textContent=track.name;
  const vol = document.createElement('input'); vol.type='range'; vol.min=0; vol.max=1; vol.step=0.01; vol.value=track.gain;
  vol.className='fader';
  vol.addEventListener('input',()=>{track.gain=parseFloat(vol.value);});
  ch.appendChild(label); ch.appendChild(vol);
  mixerDiv.appendChild(ch);
});

/* =======================
   SYNTH PLAYBACK WITH ADSR & FILTER
======================= */
function playSynth(type, freq=220, gain=0.5){
  const osc = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  g.gain.setValueAtTime(0, audioCtx.currentTime);
  g.gain.linearRampToValueAtTime(gain, audioCtx.currentTime + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.25);

  if(type==='saw') osc.type='sawtooth';
  else if(type==='pad') osc.type='sine';
  else if(type==='noise'){
    const bufferSize = audioCtx.sampleRate * 0.2;
    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for(let i=0;i<bufferSize;i++) data[i] = Math.random()*2-1;
    const noise = audioCtx.createBufferSource();
    noise.buffer = buffer;
    noise.connect(g).connect(audioCtx.destination);
    noise.start();
    return;
  }

  osc.frequency.value = freq;
  osc.connect(g).connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + 0.25);
}

/* =======================
   SAMPLE PLAYBACK
======================= */
function playSample(buffer, gain=1){
  const src = audioCtx.createBufferSource();
  src.buffer = buffer;
  const g = audioCtx.createGain();
  g.gain.value = gain;
  src.connect(g).connect(audioCtx.destination);
  src.start();
}

/* =======================
   SIDECHAIN DUCKING
======================= */
function applySidechain(track){
  if(track.sidechain){
    // Simple sidechain: reduce gain if Kick is active
    const kickStep = tracks[0].steps[currentStep];
    if(kickStep) track.gain *= 0.5;
  }
  return track.gain;
}

/* =======================
   STEP SEQUENCER
======================= */
function stepSequencer(){
  tracks.forEach(track=>{
    const stepGain = applySidechain(track);
    if(track.steps[currentStep]){
      if(track.type==='sample' && track.buffer) playSample(track.buffer, stepGain);
      if(track.type==='synth') playSynth(track.synth, 60+currentStep*10, stepGain);
    }
  });

  // Apply swing
  let delay = stepInterval;
  if(currentStep % 2 === 1) delay += stepInterval * swing;

  currentStep = (currentStep+1)%16;
  if(isPlaying) setTimeout(stepSequencer, delay*1000);
}

/* =======================
   BUTTONS
======================= */
document.getElementById('playStop').addEventListener('click',()=>{
  if(!isPlaying){isPlaying=true; stepSequencer();}
  else{isPlaying=false; currentStep=0;}
});

document.getElementById('randomize').addEventListener('click',()=>{
  tracks.forEach(track=>{
    track.steps = track.steps.map(()=>Math.random()>0.7);
    const row = sequencerDiv.children[tracks.indexOf(track)];
    track.steps.forEach((val,i)=>{
      row.children[i].classList.toggle('active', val);
    });
  });
});

/* =======================
   RECORDING
======================= */
let mediaRecorder;
let recordedChunks=[];
document.getElementById('recordBtn').addEventListener('click',async()=>{
  if(!mediaRecorder || mediaRecorder.state==='inactive'){
    const dest = audioCtx.createMediaStreamDestination();
    audioCtx.destination.connect(dest);
    mediaRecorder = new MediaRecorder(dest.stream);
    mediaRecorder.ondataavailable = e=>{recordedChunks.push(e.data);};
    mediaRecorder.onstop = ()=>{
      const blob = new Blob(recordedChunks,{type:'audio/wav'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download='haus_deck_recording.wav';
      a.click();
      recordedChunks=[];
    };
    mediaRecorder.start();
  } else mediaRecorder.stop();
});

/* =======================
   VISUALIZER
======================= */
const canvas = document.getElementById('visualizer');
const ctx = canvas.getContext('2d');
const analyser = audioCtx.createAnalyser();
analyser.fftSize = 256;
const dataArray = new Uint8Array(analyser.frequencyBinCount);
audioCtx.destination.connect(analyser);

function drawVisualizer(){
  requestAnimationFrame(drawVisualizer);
  analyser.getByteFrequencyData(dataArray);
  ctx.fillStyle = '#000';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  const barWidth = canvas.width / dataArray.length;
  for(let i=0;i<dataArray.length;i++){
    const h = dataArray[i];
    ctx.fillStyle = `rgb(${h+50},50,${200})`;
    ctx.fillRect(i*barWidth, canvas.height-h, barWidth, h);
  }
}
drawVisualizer();

/* =======================
   GENRE PRESETS
======================= */
const presets = {
  deep: [
    [1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],
    [0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,0,0,1,0,1,0,0,1,0,0,1,0,1,0,0],
    [0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],
    [0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1]
  ],
  tech: [
    [1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1],
    [0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],
    [0,1,0,0,1,0,1,0,0,1,0,1,0,0,1,0],
    [0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0]
  ],
  chill: [
    [1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],
    [0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],
    [0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],
    [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],
    [0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1],
    [0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1]
  ],
  lofi: [
    [1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],
    [0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],
    [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0],
    [0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],
    [0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],
    [0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1]
  ],
  progressive:[
    [1,0,0,1,0,1,0,0,1,0,0,1,0,1,0,0],
    [0,1,0,0,1,0,1,0,0,1,0,1,0,0,1,0],
    [1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1],
    [0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1],
    [1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],
    [0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0]
  ]
};

document.getElementById('genreSelect').addEventListener('change', e=>{
  const preset = presets[e.target.value];
  if(!preset) return;
  tracks.forEach((track,i)=>{
    track.steps = preset[i].slice();
    const row = sequencerDiv.children[i];
    track.steps.forEach((val,j)=>{
      row.children[j].classList.toggle('active', val);
    });
  });
});
</script>
</body>
</html>
